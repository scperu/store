<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KingCar E-Commerce Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f8f9fb;
      margin: 0;
      padding: 0;
      color: #333;
    }

    header {
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 1rem 2rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      font-weight: 600;
      font-size: 1.4rem;
      color: #111;
    }

    select {
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.9rem;
      background: #fff;
    }

    main {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s;
      cursor: pointer;
    }

    .card:hover { transform: translateY(-5px); }

    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .card-content {
      padding: 1rem;
    }

    .card h3 {
      font-size: 1rem;
      margin: 0 0 0.5rem;
      color: #111;
    }

    .price {
      font-weight: 600;
      color: #0070f3;
      margin-bottom: 0.5rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      text-align: center;
      position: relative;
    }

    .modal-content img, .modal-content video {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      background: #ff3b3b;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-weight: bold;
      cursor: pointer;
    }

    .modal-colors {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 1rem;
    }

    .color-btn {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      border: 2px solid #ccc;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .color-btn:hover { transform: scale(1.2); }
    .color-btn.active { border-color: #0070f3; transform: scale(1.3); }

    .stock-status {
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 0.5rem;
    }

    .stock-ok { color: green; }
    .stock-out { color: red; }
  </style>
</head>

<body>
  <header>
    <h1>ðŸš— KingCar Store</h1>
    <select id="filterMarca"><option value="">Todas las marcas</option></select>
    <select id="filterModelo"><option value="">Todos los modelos</option></select>
  </header>

  <main id="productContainer"></main>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">Ã—</button>
      <div id="mediaContainer"></div>
      <h2 id="modalTitle"></h2>
      <p id="modalStock"></p>
      <div class="modal-colors" id="modalColors"></div>
    </div>
  </div>

  <script>
    const container = document.getElementById('productContainer');
    const filterMarca = document.getElementById('filterMarca');
    const filterModelo = document.getElementById('filterModelo');
    const modal = document.getElementById('modal');
    const mediaContainer = document.getElementById('mediaContainer');
    const modalTitle = document.getElementById('modalTitle');
    const modalStock = document.getElementById('modalStock');
    const modalColors = document.getElementById('modalColors');

    let groupedData = {};

    const colorMap = {
      "ROJO": "red", "AZUL": "blue", "VERDE": "green", "AMARILLO": "gold",
      "NEGRO": "black", "BLANCO": "white", "GRIS": "gray", "GUINDO": "#800020",
      "MARRON": "brown", "PLATA": "silver", "NARANJA": "orange",
      "ROSADO": "pink", "CELESTE": "#87CEEB", "MORADO": "purple",
      "FUCSIA": "#ff00aa", "DORADO": "#FFD700", "TURQUESA": "#40E0D0"
    };

    window.addEventListener('load', loadFromGitHub);

    async function loadFromGitHub() {
      const url = "https://scperu.github.io/store/kingcar.xlsx";
      try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const products = XLSX.utils.sheet_to_json(sheet);
        groupedData = groupProducts(products);
        populateFilters(products);
        renderProducts(groupedData);
      } catch (error) {
        console.error("Error cargando Excel:", error);
      }
    }

    function groupProducts(products) {
      const grouped = {};
      products.forEach(p => {
        const baseName = getBaseName(p.DESCRIPCION);
        if (!grouped[baseName]) grouped[baseName] = [];
        grouped[baseName].push(p);
      });
      return grouped;
    }

    function getBaseName(desc) {
      for (const color in colorMap) {
        const regex = new RegExp("\\b" + color + "\\b", "i");
        desc = desc.replace(regex, "").trim();
      }
      return desc;
    }

    function extractColor(desc) {
      for (const key in colorMap) {
        if (desc.toUpperCase().includes(key)) return key;
      }
      return null;
    }

    function populateFilters(products) {
      const marcas = [...new Set(products.map(p => p.MARCA))];
      const modelos = [...new Set(products.map(p => p.MODELO))];
      filterMarca.innerHTML = '<option value="">Todas las marcas</option>' + marcas.map(m => `<option value="${m}">${m}</option>`).join('');
      filterModelo.innerHTML = '<option value="">Todos los modelos</option>' + modelos.map(m => `<option value="${m}">${m}</option>`).join('');
      filterMarca.onchange = applyFilters;
      filterModelo.onchange = applyFilters;
    }

    function applyFilters() {
      const marca = filterMarca.value;
      const modelo = filterModelo.value;
      const filtered = {};
      for (const auto in groupedData) {
        const variants = groupedData[auto].filter(v =>
          (!marca || v.MARCA === marca) &&
          (!modelo || v.MODELO === modelo)
        );
        if (variants.length) filtered[auto] = variants;
      }
      renderProducts(filtered);
    }

    function renderProducts(grouped) {
      container.innerHTML = '';
      for (const auto in grouped) {
        let variants = grouped[auto];
        variants.sort((a,b)=>(b.STOCK||0)-(a.STOCK||0));
        const first = variants[0];

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${first.IMAGEN}" alt="${auto}">
          <div class="card-content">
            <h3>${auto}</h3>
            <div class="price">S/ ${first["PRECIO EN SOLES"]}</div>
          </div>
        `;
        card.addEventListener('click', () => openModal(auto, variants));
        container.appendChild(card);
      }
    }

    function openModal(auto, variants) {
      modal.classList.add('active');
      modalTitle.textContent = auto;
      modalColors.innerHTML = '';
      variants.sort((a,b)=>(b.STOCK||0)-(a.STOCK||0));

      variants.forEach((v, i) => {
        const color = extractColor(v.DESCRIPCION);
        const btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.background = colorMap[color] || '#ccc';
        btn.title = color;
        btn.onclick = () => showVariant(v);
        modalColors.appendChild(btn);
        if (i === 0) btn.click();
      });
    }

    function showVariant(item) {
      mediaContainer.innerHTML = '';
      if (item.MODAL && item.MODAL.endsWith(".mp4")) {
        mediaContainer.innerHTML = `<video src="${item.MODAL}" controls autoplay loop></video>`;
      } else if (item.MODAL) {
        mediaContainer.innerHTML = `<iframe width="100%" height="315" src="${item.MODAL}" frameborder="0" allowfullscreen></iframe>`;
      } else {
        mediaContainer.innerHTML = `<img src="${item.IMAGEN}" alt="${item.DESCRIPCION}">`;
      }

      modalStock.textContent = item.STOCK > 0 ? "ðŸŸ¢ Disponible" : "ðŸ”´ Agotado";
      modalStock.className = item.STOCK > 0 ? "stock-status stock-ok" : "stock-status stock-out";
    }

    function closeModal() {
      modal.classList.remove('active');
      mediaContainer.innerHTML = '';
    }

    /* ðŸ›¡ï¸ Bloqueo del clic derecho y atajos */
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.onkeydown = function(e) {
      if (e.keyCode === 123) return false; // F12
      if (e.ctrlKey && e.shiftKey && e.keyCode === 73) return false; // Ctrl+Shift+I
      if (e.ctrlKey && e.keyCode === 85) return false; // Ctrl+U
    };
  </script>
</body>
</html>
