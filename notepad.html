<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ServiComp</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      text-align: center;
      margin: 0;
      background: linear-gradient(135deg, #dfe9f3, #ffffff);
      padding: 40px;
      user-select: none; /* evita selecci√≥n de texto */
    }
    h2 { color: #222; }
    .img-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      margin-top: 30px;
    }
    .imagen {
      width: 260px;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: transform 0.2s;
      -webkit-user-drag: none;
    }
    .imagen:hover { transform: scale(1.05); }
    .modal, .auth-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(6px);
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    .modal-content, .auth-content {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      border-radius: 14px;
      width: 360px;
      padding: 25px;
      text-align: left;
      animation: fadeIn 0.3s ease;
      position: relative;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to { opacity:1; transform:translateY(0); } }
    .close { position: absolute; top: 10px; right: 15px; font-size: 20px; cursor: pointer; color: #fff; }
    .nota {
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 8px 10px;
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .copy-icon { cursor: pointer; color: #00c3ff; transition: 0.2s; }
    .copy-icon:hover { color: #fff; transform: scale(1.2); }
    .copiado { color: #b3ffb3; font-size: 14px; text-align: center; display: none; margin-top: 10px; color: #0f0; }
    input[type="password"], input[type="text"] {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
      background: rgba(255,255,255,0.8);
      color: #333;
    }
    .btn {
      margin-top: 12px;
      padding: 8px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(135deg, #00c3ff, #0078ff);
      color: white;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
    }
    .btn:hover { background: linear-gradient(135deg, #0099ff, #005fcc); }
    .error { color: #ff9090; font-size: 13px; display: none; text-align: center; margin-top: 8px; }
    .locked-msg { color: #fff; margin-bottom: 6px; text-align:center; }
  </style>
</head>
<body>

  <h2> ServiComp - Soluciones IT </h2>
  <div id="contenedor" class="img-container"></div>

  <!-- Modal para cada item -->
  <div id="modal" class="modal">
    <div class="modal-content" id="modal-content">
      <span class="close">&times;</span>
      <div id="contenidoModal"></div>
    </div>
  </div>

  <!-- Modal de autenticaci√≥n global al abrir/refresh -->
  <div id="authModal" class="auth-modal">
    <div class="auth-content">

      <h3> ServiComp IT</h3>
      <p>üîê Escribe la clave por favor</p>

      <input type="password" id="authInput" placeholder="Escribe la clave...">
      <button class="btn" id="authBtn">Acceder</button>
      <p id="authError" class="error">‚ùå Clave incorrecta</p>
    </div>
  </div>

  <script>
    // üîí Desactivar clic derecho en toda la p√°gina
    document.addEventListener("contextmenu", e => e.preventDefault());
    // üîí Desactivar combinaciones comunes (Ctrl+U, Ctrl+Shift+I, etc.)
    document.addEventListener("keydown", function(e) {
      if (e.ctrlKey && (e.key === "u" || e.key === "U" || e.key === "s" || e.key === "S" || e.key === "p" || e.key === "P")) e.preventDefault();
      if ((e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "i")) || (e.ctrlKey && e.key === "j")) e.preventDefault();
      if (e.key === "F12") e.preventDefault();
    });

    const contenedor = document.getElementById('contenedor');
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('contenidoModal');
    const closeBtn = document.querySelector('.close');
    const authModal = document.getElementById('authModal');
    const authBtn = document.getElementById('authBtn');
    const authError = document.getElementById('authError');

    let data = {}; // se llenar√° con los bloques
    let clavesDisponibles = []; // lista de claves v√°lidas (de bloques y autom√°ticas)

    const txtUrl = "https://scperu.github.io/store/notepad.txt";

    // Auto-reload cada 5 minutos (300000 ms)
    const AUTO_REFRESH_MS = 5 * 60 * 1000;
    setTimeout(() => { location.reload(); }, AUTO_REFRESH_MS);

    // Calcula clave actual en formato HHMM (dos d√≠gitos)
    function ahoraClave() {
      const d = new Date();
      const hh = ("0" + d.getHours()).slice(-2);
      const mm = ("0" + d.getMinutes()).slice(-2);
      return hh + mm;
    }

    // Mostrar modal de autenticaci√≥n global
    function showAuthModal() {
      authModal.style.display = "flex";
      document.getElementById('authInput').value = "";
      authError.style.display = 'none';
      // focus
      setTimeout(() => document.getElementById('authInput').focus(), 200);
    }

    authBtn.addEventListener('click', () => {
      verificarAuth();
    });
    document.getElementById('authInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') verificarAuth();
    });

    function verificarAuth() {
      const v = document.getElementById('authInput').value.trim();
      const current = ahoraClave();
      // aceptamos si coincide con cualquier clave disponible (incluyendo claves autom√°ticas calculadas)
      if (clavesDisponibles.includes(v) || v === current) {
        authModal.style.display = "none";
        // mostrar contenido (las tarjetas) ya se generaron en parseTXT
        contenedor.style.display = "flex";
      } else {
        authError.style.display = 'block';
      }
    }

    // Cargar y parsear archivo TXT remoto
    fetch(txtUrl)
      .then(res => {
        if (!res.ok) throw new Error("No se pudo cargar el TXT");
        return res.text();
      })
      .then(text => parseTXT(text))
      .catch(err => {
        console.error("Error cargando notepad.txt:", err);
        modal.style.display = "flex";
        modalContent.innerHTML = `<h3>Error</h3><p>No se pudo cargar las notas.</p>`;
      });

    function parseTXT(text) {
      // al inicio ocultamos contenedor hasta autenticaci√≥n
      contenedor.style.display = "none";
      data = {};
      clavesDisponibles = [];

      const bloques = text.trim().split(/\n\s*\n/);
      const defaultClave = ahoraClave();

      bloques.forEach((b, i) => {
        const lineas = b.trim().split("\n").map(l => l.trim()).filter(Boolean);
        const nombre = lineas[0] || `IMAGEN${i+1}`;
        const url = lineas[1] || "";
        const claveLine = lineas.find(l => l.toLowerCase().startsWith("clave:"));
        let clave = claveLine ? claveLine.split(":")[1].trim() : "";

        // Si no hay clave, asignar la clave basada en la hora/minuto al abrir la p√°gina
        if (!clave) {
          clave = defaultClave; // patr√≥n HHMM calculado al abrir
        }

        // recolectar grupos y notas
        const grupos = [];
        let grupoActual = null;
        lineas.forEach(l => {
          const lower = l.toLowerCase();
          if (lower.startsWith("grupo")) {
            grupoActual = { nombre: l, notas: [] };
            grupos.push(grupoActual);
          } else if (lower.startsWith("nota")) {
            if (grupoActual) grupoActual.notas.push(l);
          }
        });

        // Clave √∫nica por bloque (nombre + √≠ndice)
        const id = `${nombre}_${i}`;
        data[id] = { nombre, url, clave, grupos };

        // A√±adir clave a la lista de claves v√°lidas
        if (clave) clavesDisponibles.push(clave);

        // Crear tarjeta visual (se mostrar√° despu√©s de pasar auth)
        const container = document.createElement("div");
        container.style.display = "flex";
        container.style.flexDirection = "column";
        container.style.alignItems = "center";

        const img = document.createElement("img");
        img.src = url;
        img.className = "imagen";
        img.title = nombre;
        img.onclick = () => pedirClave(id); // pedir clave por item al hacer clic (adem√°s de auth global)

        const label = document.createElement("p");
        label.textContent = nombre;
        label.style.marginTop = "8px";
        label.style.fontWeight = "bold";
        label.style.color = "#333";

        container.appendChild(img);
        container.appendChild(label);
        contenedor.appendChild(container);
      });

      // despu√©s de parsear, mostrar modal auth global para desbloquear
      showAuthModal();
    }

    // Modal por item (pide clave individual al hacer clic)
    function pedirClave(id) {
      const item = data[id];
      modal.style.display = "flex";
      modalContent.innerHTML = `
        <h3>üîê ${item.nombre}</h3>
        <p>Introduce la clave para acceder:</p>
        <input type="password" id="claveInput" placeholder="Escribe la clave...">
        <button class="btn" onclick="verificarClave('${id}')">Acceder</button>
        <p id="errorClave" class="error">‚ùå Clave incorrecta</p>
      `;
      setTimeout(() => document.getElementById('claveInput').focus(), 150);
    }

    function verificarClave(id) {
      const item = data[id];
      const claveInput = document.getElementById('claveInput').value.trim();
      const error = document.getElementById('errorClave');
      // Si la clave del item coincide o si la clave ingresada coincide con la clave autom√°tica actual -> OK
      if (claveInput === item.clave) {

        mostrarNotas(id);
      } else {
        error.style.display = 'block';
      }
    }

    function mostrarNotas(id) {
      const item = data[id];
      modalContent.innerHTML = `<h3>üìÑ ${item.nombre}</h3>`;
      item.grupos.forEach(g => {
        const grupoDiv = document.createElement("div");
        grupoDiv.innerHTML = `<h4>${g.nombre}</h4>`;
        g.notas.forEach(nota => {
          const notaEl = document.createElement("div");
          notaEl.className = "nota";
          // sanitizar texto m√≠nimo (evitar inyecci√≥n)
          const safe = nota.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          notaEl.innerHTML = `<span>${safe}</span><span class="copy-icon" onclick="copiar('${safe}', this)">üìã</span>`;
          grupoDiv.appendChild(notaEl);
        });
        modalContent.appendChild(grupoDiv);
      });

      const mensaje = document.createElement("p");
      mensaje.className = "copiado";
      mensaje.id = "mensajeCopiado";
      mensaje.textContent = "‚úÖ Copiado";
      modalContent.appendChild(mensaje);
    }

    function copiar(txt, icono) {
      // quitar caracteres escapados al copiar (reemplaza entidades)
      const textToCopy = txt.replace(/&lt;/g, "<").replace(/&gt;/g, ">");
      navigator.clipboard.writeText(textToCopy);
      const msg = document.getElementById("mensajeCopiado");
      if (msg) msg.style.display = "block";
      icono.textContent = "‚úÖ";
      setTimeout(() => {
        if (msg) msg.style.display = "none";
        icono.textContent = "üìã";
      }, 1500);
    }

    closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = e => {
      if (e.target === modal) modal.style.display = "none";
      if (e.target === authModal) {
        // mantener bloqueado si hace click fuera del auth -> no permitir cerrar sin clave
        // authModal.style.display = "flex"; // dejamos que siga visible (no cerramos)
      }
    };

    // Por seguridad: cada vez que la p√°gina vuelva a visibilidad visible (ej. cambio de pesta√±a),
    // podemos (opcionalmente) volver a pedir clave. Aqu√≠ lo dejamos desactivado pero lo muestro:
    // document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') showAuthModal(); });

  </script>
</body>
</html>
