<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>Cotizador ServiComp+</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 (Solo para errores) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* SEGURIDAD: Bloqueo de selección SOLO en elementos de lectura */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* PERMITIR INTERACCIÓN TOTAL EN INPUTS (CRÍTICO PARA MÓVIL) */
        input, textarea {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            -webkit-touch-callout: default !important;
        }

        img { pointer-events: none; }

        .input-code {
            letter-spacing: 1px;
            font-weight: 700;
            text-transform: uppercase;
            font-family: monospace;
        }
        
        .product-card { transition: all 0.2s ease; }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col relative">

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white shadow-lg sticky top-0 z-50 border-b border-slate-800">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 bg-white rounded-lg flex items-center justify-center overflow-hidden p-1">
                    <img src="https://scperu.github.io/store/logo.png" alt="Logo" class="w-full h-full object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                    <i class="fa-solid fa-microchip text-slate-900 text-xl hidden"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-none tracking-tight">ServiComp<span class="text-red-400">+</span></h1>
                    <span class="text-[10px] text-gray-400 uppercase tracking-widest">Soluciones TI</span>
                </div>
            </div>
            <div class="text-right text-xs leading-tight">
                <div id="dateDisplay" class="text-slate-300 mb-0.5 capitalize">...</div>
                <div id="exchangeRate" class="text-blue-400 font-bold bg-slate-800 px-2 py-0.5 rounded inline-block">TC: ...</div>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- COLUMNA IZQUIERDA -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 sticky top-24 z-30">
                <div class="flex justify-between items-end mb-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase ml-1">Código de cotización</label>
                    <span class="text-[10px] text-blue-600 bg-blue-50 px-2 py-0.5 rounded font-bold">En Vivo</span>
                </div>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fa-solid fa-barcode text-slate-400 text-lg"></i>
                    </div>
                    <!-- INPUT PRINCIPAL -->
                    <input type="text" id="mainInput" 
                        class="input-code w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-300 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-lg text-slate-800 placeholder-slate-400 shadow-inner"
                        placeholder="Pegar código aquí..." 
                        autofocus autocomplete="off">
                </div>
                <p class="text-xs text-slate-400 mt-2 ml-1 flex items-center gap-1">
                    <i class="fa-solid fa-circle-info"></i> Pega tu código de cotización.
                </p>
            </div>

            <div id="resultsArea" class="flex flex-col gap-3 min-h-[200px]">
                <div class="flex flex-col items-center justify-center py-12 text-slate-400 bg-white rounded-2xl border-2 border-dashed border-slate-200 h-full opacity-60">
                    <i class="fa-solid fa-arrow-up text-3xl mb-3"></i>
                    <p>Listo para cotizar.</p>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA -->
        <div class="lg:col-span-1">
            <div class="sticky top-24 space-y-4">
                
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 ring-1 ring-slate-900/5">
                    <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-100">
                        <h3 class="font-bold text-slate-800 text-lg">Resumen</h3>
                        <span class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded-full" id="itemsBadge">0 items</span>
                    </div>
                    
                    <div class="space-y-3 text-sm mb-6">
                        <div class="flex justify-between text-slate-600">
                            <span>Subtotal</span>
                            <span class="font-medium text-slate-900" id="subtotalVal">S/ 0</span>
                        </div>
                        <div class="flex justify-between text-slate-600 items-center">
                            <span class="flex items-center gap-1"><i class="fa-solid fa-truck-fast text-slate-400"></i> Envío</span>
                            <span class="font-medium text-slate-900" id="shippingVal">S/ 0</span>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6">
                        <div class="flex justify-between items-end">
                            <span class="text-slate-600 font-bold text-xs mb-1 uppercase">Total a Pagar</span>
                            <span id="totalVal" class="text-3xl font-black text-blue-700 leading-none">S/ 0</span>
                        </div>
                    </div>

                    <div class="mb-6 border-t border-slate-100 pt-4">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 text-center">Aceptamos</p>
                        <div class="flex justify-center gap-3">
                            <div class="bg-orange-50 border border-orange-100 px-4 py-1.5 rounded flex items-center gap-2 shadow-sm">
                                <i class="fa-solid fa-bank text-orange-500"></i>
                                <span class="text-xs font-bold text-orange-800">BCP</span>
                            </div>
                            <div class="bg-purple-50 border border-purple-100 px-4 py-1.5 rounded flex items-center gap-2 shadow-sm">
                                <i class="fa-solid fa-mobile-screen text-purple-600"></i>
                                <span class="text-xs font-bold text-purple-800">YAPE</span>
                            </div>
                        </div>
                    </div>

                    <button onclick="window.print()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-medium py-3.5 px-4 rounded-xl transition duration-200 flex items-center justify-center gap-2 text-sm shadow-lg hover:shadow-xl transform active:scale-[0.98]">
                        <i class="fa-solid fa-file-pdf"></i> Guardar Cotización PDF
                    </button>
                    
                    <p class="text-[10px] text-center text-slate-400 mt-4 leading-relaxed">
                        Precios válidos por 24 horas o hasta agotar stock.<br>Incluye IGV. Imágenes referenciales.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- SCRIPTS -->
    <script>
        /* --- SEGURIDAD HÍBRIDA (Compatible con Móvil) --- */
        document.addEventListener('contextmenu', function(e) {
            // Permitir menú solo en inputs
            if (e.target.nodeName === 'INPUT' || e.target.nodeName === 'TEXTAREA') return true;
            e.preventDefault(); return false;
        });

        /* --- CONFIGURACIÓN --- */
        const _0x1a2b = "aHR0cHM6Ly9zY3BlcnUuZ2l0aHViLmlvL3N0b3JlL3Byb2R1Y3Rvcy54bHN4"; 
        const CONFIG = {
            excelUrl: atob(_0x1a2b),
            baseShipping: 19
        };

        let inventory = [];
        let globalExchangeRate = 0;
        const moneyFormatter = new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        function formatMoney(amount) { return "S/ " + moneyFormatter.format(amount); }

        document.addEventListener('DOMContentLoaded', async () => {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-PE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('dateDisplay').textContent = dateStr;

            await initDatabase();
            
            // Foco automático en el input al cargar
            document.getElementById('mainInput').focus();
            document.getElementById('mainInput').addEventListener('input', (e) => processCodes(e.target.value));
        });

        async function initDatabase() {
            try {
                const response = await fetch(CONFIG.excelUrl);
                const buffer = await response.arrayBuffer();
                const workbook = XLSX.read(buffer, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];

                if (sheet['K2']) {
                    globalExchangeRate = parseFloat(sheet['K2'].v);
                    document.getElementById('exchangeRate').textContent = "TC: " + globalExchangeRate.toFixed(3);
                }

                const rawData = XLSX.utils.sheet_to_json(sheet);
                
                inventory = rawData.map(row => {
                    const keys = Object.keys(row);
                    const getCol = (str) => {
                        const k = keys.find(key => key.toLowerCase().includes(str));
                        return k ? row[k] : "";
                    };
                    
                    const codeKey = keys.find(k => k.toLowerCase().includes("codigo") || k.toLowerCase().includes("código") && !k.toLowerCase().includes("mini"));
                    const miniKey = keys.find(k => k.toLowerCase().includes("mini"));
                    
                    let rawStock = getCol("stock");
                    if (typeof rawStock === 'string') rawStock = parseInt(rawStock.replace(/,/g, '')) || 0;

                    return {
                        codigo: row[codeKey] || "N/A",
                        mini: String(row[miniKey] || "").trim(),
                        desc: getCol("descrip"),
                        marca: getCol("marca"),
                        detalles: getCol("detalles"),
                        precio: parseFloat(getCol("soles")) || 0,
                        stock: rawStock
                    };
                });

                document.getElementById('resultsArea').innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-slate-400 bg-white rounded-2xl border-2 border-dashed border-slate-200 h-full opacity-60">
                        <i class="fa-solid fa-arrow-up text-3xl mb-3"></i>
                        <p>Listo para cotizar.</p>
                    </div>`;

            } catch (err) {
                Swal.fire("Error", "Error de conexión con base de datos.", "error");
            }
        }

        /* --- FUNCIÓN PARA DESCOMPACTAR BASE62 --- */
        function descompactarBase62(compactado) {
            const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let valor = 0n;
            for (let char of compactado) {
                const index = chars.indexOf(char);
                if (index === -1) return null; // No es válido
                valor = valor * 62n + BigInt(index);
            }
            
            // Rellenar ceros y dividir en grupos de 6
            let texto = valor.toString();
            // Aseguramos que sea múltiplo de 6 para cortar bien
            const targetLen = Math.ceil(texto.length / 6) * 6;
            texto = texto.padStart(targetLen, '0');
            
            // Retorna array de strings ["470601", "037265", ...]
            return texto.match(/.{1,6}/g);
        }

        /* --- LÓGICA DE PROCESAMIENTO CORREGIDA --- */
        function processCodes(inputString) {
            if (!inputString) {
                renderList([]);
                return;
            }

            let cleanInput = inputString.trim();
            let searchCodes = [];

            // 1. DETECCIÓN INTELIGENTE
            // Si no tiene guiones y es alfanumérico, asumimos Base62 (incluso si es corto)
            const hasHyphen = cleanInput.includes("-");
            const isBase62 = /^[0-9a-zA-Z]+$/.test(cleanInput);

            if (!hasHyphen && isBase62) {
                // INTENTAR DESCOMPACTAR
                const decoded = descompactarBase62(cleanInput);
                
                if (decoded && decoded.length > 0) {
                    // ÉXITO: Es un código compactado
                    // IMPORTANTE: Normalizar (quitar ceros a la izquierda) para buscar en el inventario
                    // El packer manda "037265", pero el inventario tiene "37265"
                    searchCodes = decoded.map(c => c.replace(/^0+/, '')); 
                } else {
                    // Falló descompactar, buscar tal cual (búsqueda normal)
                    searchCodes = [cleanInput];
                }
            } else {
                // 2. MODO NORMAL (Con guiones o texto simple)
                searchCodes = cleanInput.split('-').map(s => s.trim()).filter(s => s);
            }

            const validCodes = searchCodes.filter(c => c.length > 0);
            const matchedProducts = [];

            // BUSCAR EN INVENTARIO
            validCodes.forEach(code => {
                // Normalizamos el código de búsqueda también aquí por seguridad
                const searchCodeNorm = code.replace(/^0+/, ''); 

                const product = inventory.find(p => {
                    // Normalizar el mini del inventario (quitar ceros izquierda)
                    const pMiniNorm = String(p.mini).trim().replace(/^0+/, '');
                    return pMiniNorm === searchCodeNorm;
                });

                if (product && product.stock > 0) {
                    matchedProducts.push(product);
                }
            });

            renderList(matchedProducts);
        }

        function renderList(products) {
            const container = document.getElementById('resultsArea');
            let subtotal = 0;

            if (products.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 text-slate-400 bg-white rounded-2xl border-2 border-dashed border-slate-200">
                    <i class="fa-solid fa-ghost text-3xl mb-3 opacity-50"></i>
                    <p>No se encontraron productos con stock.</p>
                </div>`;
                updateTotals(0, 0);
                return;
            }

            let html = '';
            products.forEach(p => {
                subtotal += p.precio;
                const photoUrl = `https://www.deltron.com.pe/modulos/productos/items/image_ext.php?item=${encodeURIComponent(p.codigo)}&nomenu=1`;
                    // Thumb pattern (foto pequeñita)
                    const c_thumb = String(p.codigo).toLowerCase().trim();
                    const sub1_thumb = c_thumb.substring(0, 2);
                    const sub2_thumb = c_thumb.substring(2, 4);
                    const thumbUrl = `https://imagenes.deltron.com.pe/images/productos/items/${sub1_thumb}/${sub2_thumb}/${c_thumb}.jpg`;


                
                html += `
                <div class="product-card bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:border-blue-200 group relative overflow-hidden">
                    <div class="flex items-start gap-4 z-10 relative">
                        <div class="flex-shrink-0 pt-1 flex flex-col items-center gap-1">
                                    <a href="${photoUrl}" target="_blank" rel="noopener noreferrer" class="w-16 h-12 rounded-lg bg-white border border-slate-200 flex items-center justify-center overflow-hidden hover:border-blue-300 transition relative shadow-sm">
                                        <img src="${thumbUrl}" alt="img" class="w-full h-full object-contain p-0.5">
                                    </a>
                                    <a href="${photoUrl}" target="_blank" rel="noopener noreferrer" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 leading-none">
                                        Ver Foto <i class="fa-solid fa-arrow-up-right-from-square text-[8px]"></i>
                                    </a>
                                </div>
                        <div class="flex-grow min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-black tracking-wider bg-slate-800 text-white px-1.5 py-0.5 rounded uppercase">${p.mini}</span>
                                <span class="text-xs font-semibold text-blue-600 uppercase tracking-wide">${p.marca}</span>
                            </div>
                            <h4 class="text-sm font-bold text-slate-800 leading-snug mb-1 pr-2">${p.desc}</h4>
                            ${p.detalles ? `<p class="text-xs text-slate-500 italic border-l-2 border-slate-200 pl-2 mb-2 line-clamp-2">${p.detalles}</p>` : ''}
                            
                            <div class="flex items-center gap-3 text-xs mt-1">
                                <span class="text-emerald-700 bg-emerald-50 px-2 py-0.5 rounded font-bold border border-current opacity-80">Stock: ${p.stock}</span>
                                <span class="text-slate-400 font-mono">Cód: ${p.codigo}</span>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 self-center">
                            <div class="text-lg font-black text-slate-800">${formatMoney(p.precio)}</div>
                        </div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
            updateTotals(subtotal, products.length);
        }

        function updateTotals(subtotal, count) {
            const shipping = count > 0 ? CONFIG.baseShipping : 0;
            const total = subtotal + shipping;

            document.getElementById('itemsBadge').textContent = count + " items";
            document.getElementById('subtotalVal').textContent = formatMoney(subtotal);
            document.getElementById('shippingVal').textContent = formatMoney(shipping);
            document.getElementById('totalVal').textContent = formatMoney(total);
        }
    </script>
</body>
</html>
